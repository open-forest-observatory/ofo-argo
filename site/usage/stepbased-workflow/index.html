
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://open-forest-observatory.github.io/ofo-argo/usage/stepbased-workflow/">
      
      
        <link rel="prev" href="../photogrammetry-workflow/">
      
      
        <link rel="next" href="../stepbased-quick-reference/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Running the step-based photogrammetry workflow - OFO Argo Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#running-the-step-based-photogrammetry-workflow" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OFO Argo Documentation" class="md-header__button md-logo" aria-label="OFO Argo Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OFO Argo Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Running the step-based photogrammetry workflow
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OFO Argo Documentation" class="md-nav__button md-logo" aria-label="OFO Argo Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    OFO Argo Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OFO Argo Workflows Documentation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    User guides
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    User guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-access-and-resizing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cluster access and resizing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../argo-usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Using Argo on the OFO cluster
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../photogrammetry-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Running the photogrammetry workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Running the step-based photogrammetry workflow
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Running the step-based photogrammetry workflow
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Benefits
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Workflow overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Workflow overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metashape-processing-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metashape Processing Steps
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-processing-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Post-Processing Steps
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare-inputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prepare inputs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prepare inputs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-drone-imagery-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Add drone imagery datasets
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specify-metashape-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Specify Metashape parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloading-imagery-from-s3-optional" class="md-nav__link">
    <span class="md-ellipsis">
      
        Downloading imagery from S3 (optional)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Downloading imagery from S3 (optional)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#when-to-use-s3-imagery-download" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to use S3 imagery download
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#path-syntax-the-__downloaded__-prefix" class="md-nav__link">
    <span class="md-ellipsis">
      
        Path syntax: The __DOWNLOADED__ prefix
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zip-file-structure-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zip file structure requirements
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-example-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Complete example configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      
        How it works
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting-s3-imagery-download" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting S3 imagery download
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting S3 imagery download">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#config-validation-failed-downloaded-prefix-used-but-no-downloads-specified" class="md-nav__link">
    <span class="md-ellipsis">
      
        "Config validation failed: DOWNLOADED prefix used but no downloads specified"
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#config-validation-failed-downloads-specified-but-no-downloaded-paths-found" class="md-nav__link">
    <span class="md-ellipsis">
      
        "Config validation failed: Downloads specified but no DOWNLOADED paths found"
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-fails-with-failed-to-copy-or-timeout-errors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Download fails with "Failed to copy" or timeout errors
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#photo-path-not-found-errors-in-setup-step" class="md-nav__link">
    <span class="md-ellipsis">
      
        "Photo path not found" errors in setup step
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disk-space-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Disk space issues
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resource-request-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Resource request configuration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Resource request configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpu-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      
        GPU scheduling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpu-resource-selection-mig-support" class="md-nav__link">
    <span class="md-ellipsis">
      
        GPU resource selection (MIG Support)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu-and-memory-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        CPU and memory configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secondary-photo-processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Secondary photo processing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Secondary photo processing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-config-list-file" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create a config list file
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#determine-the-maximum-number-of-projects-to-process-in-parallel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Determine the maximum number of projects to process in parallel
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adjusting-parallelism-on-a-running-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adjusting parallelism on a running workflow
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#submit-the-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Submit the workflow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Submit the workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#workflow-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Workflow parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor-the-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitor the workflow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitor the workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-argo-ui" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using the Argo UI
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Using the Argo UI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#navigating-the-argo-ui" class="md-nav__link">
    <span class="md-ellipsis">
      
        Navigating the Argo UI
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-mission-miew" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-mission miew
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#understanding-step-names" class="md-nav__link">
    <span class="md-ellipsis">
      
        Understanding step names
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-the-cli" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using the CLI
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow-outputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Workflow outputs
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stepbased-quick-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step-based workflow quick reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../admin/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Administrator guides
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Administrator guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../admin/cluster-creation-and-resizing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cluster creation and resizing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../admin/manila-share-mounting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Manila share mounting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../admin/argo-installation-on-cluster/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Argo installation on cluster
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Benefits
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Workflow overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Workflow overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metashape-processing-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metashape Processing Steps
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-processing-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Post-Processing Steps
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare-inputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prepare inputs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prepare inputs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-drone-imagery-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Add drone imagery datasets
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specify-metashape-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Specify Metashape parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloading-imagery-from-s3-optional" class="md-nav__link">
    <span class="md-ellipsis">
      
        Downloading imagery from S3 (optional)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Downloading imagery from S3 (optional)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#when-to-use-s3-imagery-download" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to use S3 imagery download
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#path-syntax-the-__downloaded__-prefix" class="md-nav__link">
    <span class="md-ellipsis">
      
        Path syntax: The __DOWNLOADED__ prefix
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zip-file-structure-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zip file structure requirements
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-example-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Complete example configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      
        How it works
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting-s3-imagery-download" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting S3 imagery download
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting S3 imagery download">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#config-validation-failed-downloaded-prefix-used-but-no-downloads-specified" class="md-nav__link">
    <span class="md-ellipsis">
      
        "Config validation failed: DOWNLOADED prefix used but no downloads specified"
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#config-validation-failed-downloads-specified-but-no-downloaded-paths-found" class="md-nav__link">
    <span class="md-ellipsis">
      
        "Config validation failed: Downloads specified but no DOWNLOADED paths found"
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-fails-with-failed-to-copy-or-timeout-errors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Download fails with "Failed to copy" or timeout errors
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#photo-path-not-found-errors-in-setup-step" class="md-nav__link">
    <span class="md-ellipsis">
      
        "Photo path not found" errors in setup step
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disk-space-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Disk space issues
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resource-request-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Resource request configuration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Resource request configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpu-scheduling" class="md-nav__link">
    <span class="md-ellipsis">
      
        GPU scheduling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpu-resource-selection-mig-support" class="md-nav__link">
    <span class="md-ellipsis">
      
        GPU resource selection (MIG Support)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu-and-memory-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        CPU and memory configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secondary-photo-processing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Secondary photo processing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Secondary photo processing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-config-list-file" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create a config list file
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#determine-the-maximum-number-of-projects-to-process-in-parallel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Determine the maximum number of projects to process in parallel
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adjusting-parallelism-on-a-running-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adjusting parallelism on a running workflow
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#submit-the-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Submit the workflow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Submit the workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#workflow-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Workflow parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor-the-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitor the workflow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitor the workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-argo-ui" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using the Argo UI
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Using the Argo UI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#navigating-the-argo-ui" class="md-nav__link">
    <span class="md-ellipsis">
      
        Navigating the Argo UI
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-mission-miew" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-mission miew
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#understanding-step-names" class="md-nav__link">
    <span class="md-ellipsis">
      
        Understanding step names
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-the-cli" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using the CLI
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow-outputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Workflow outputs
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="running-the-step-based-photogrammetry-workflow">Running the step-based photogrammetry workflow</h1>
<div class="admonition success">
<p class="admonition-title">Recommended Workflow</p>
<p>This is the <strong>recommended workflow</strong> for photogrammetry processing. It provides optimized resource allocation, cost savings, and better monitoring compared to the <a href="../photogrammetry-workflow/">original monolithic workflow</a>.</p>
</div>
<p>This guide describes how to run the OFO <strong>step-based photogrammetry workflow</strong>, which splits Metashape processing into 10 individual steps with optimized CPU/GPU node allocation. The workflow uses <a href="https://github.com/open-forest-observatory/automate-metashape">automate-metashape</a> and performs post-processing steps.</p>
<h2 id="key-benefits">Key Benefits</h2>
<ul>
<li>üéØ <strong>GPU steps</strong> (match_photos, build_depth_maps, build_mesh) run on expensive GPU nodes only when needed</li>
<li>üíª <strong>CPU steps</strong> (align_cameras, build_point_cloud, build_dem_orthomosaic, etc.) run on cheaper CPU nodes</li>
<li>‚ö° <strong>Disabled steps</strong> are completely skipped (no pod creation, no resource allocation)</li>
<li>üìä <strong>Fine-grained monitoring</strong> - Track progress of each individual step in the Argo UI</li>
<li>üîß <strong>Flexible GPU usage</strong> - Configure whether GPU-capable steps use GPU or CPU nodes</li>
<li>üí∞ <strong>Cost optimization</strong> - Reduce GPU usage by 60-80% compared to monolithic workflow</li>
</ul>
<h2 id="prerequisites">Prerequisites</h2>
<p>Before running the workflow, ensure you have:</p>
<ol>
<li><a href="../cluster-access-and-resizing/">Installed and set up</a> the <code>openstack</code> and <code>kubectl</code> utilities</li>
<li><a href="../argo-usage/">Installed</a> the Argo CLI</li>
<li><a href="../cluster-access-and-resizing/#cluster-resizing">Added</a> the appropriate type and number of nodes to the cluster</li>
<li>Set up your <code>kubectl</code> authentication env var (part of instructions for adding nodes). Quick reference:</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>source ~/venv/openstack/bin/activate
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>source ~/.ofocluster/app-cred-ofocluster-openrc.sh
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>export KUBECONFIG=~/.ofocluster/ofocluster.kubeconfig
</code></pre></div>
<h2 id="workflow-overview">Workflow overview</h2>
<p>The step-based workflow executes <strong>10 separate Metashape processing steps</strong> as individual containerized tasks, followed by upload, post-processing, and cleanup. Each mission processes sequentially through these steps:</p>
<h3 id="metashape-processing-steps">Metashape Processing Steps</h3>
<ol>
<li><strong>setup</strong> (CPU) - Initialize project, add photos, calibrate reflectance</li>
<li><strong>match_photos</strong> (GPU/CPU configurable) - Generate tie points for camera alignment</li>
<li><strong>align_cameras</strong> (CPU) - Align cameras, add GCPs, optimize, filter sparse points</li>
<li><strong>build_depth_maps</strong> (GPU) - Create depth maps for dense reconstruction</li>
<li><strong>build_point_cloud</strong> (CPU) - Generate dense point cloud from depth maps</li>
<li><strong>build_mesh</strong> (GPU/CPU configurable) - Build 3D mesh model</li>
<li><strong>build_dem_orthomosaic</strong> (CPU) - Create DEMs and orthomosaic products</li>
<li><strong>match_photos_secondary</strong> (GPU/CPU configurable, optional) - Match secondary photos if provided</li>
<li><strong>align_cameras_secondary</strong> (CPU, optional) - Align secondary cameras if provided</li>
<li><strong>finalize</strong> (CPU) - Cleanup, generate reports</li>
</ol>
<h3 id="post-processing-steps">Post-Processing Steps</h3>
<ol>
<li><strong>rclone-upload-task</strong> - Upload Metashape outputs to S3</li>
<li><strong>postprocessing-task</strong> - Generate CHMs, clip to boundaries, create COGs and thumbnails, upload to S3</li>
<li><strong>cleanup-iteration</strong> - Remove temporary iteration directories after successful postprocessing</li>
</ol>
<div class="admonition info">
<p class="admonition-title">Sequential Execution</p>
<p>Steps execute <strong>sequentially within each mission</strong> to prevent conflicts with shared Metashape project files. However, <strong>multiple missions process in parallel</strong>, each with its own step sequence.</p>
<p><strong>Automatic Cleanup:</strong> After postprocessing completes successfully, the workflow automatically removes the temporary iteration directory (<code>{TEMP_WORKING_DIR}/{workflow-name}/{iteration-id}/</code>) to free disk space, keeping only the final products uploaded to S3.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Conditional Execution</p>
<p>Steps disabled in your config file are <strong>completely skipped</strong> - no container is created and no resources are allocated. This is more efficient than the original workflow where disabled operations still ran inside a single long-running container.</p>
</div>
<h2 id="setup">Setup</h2>
<h3 id="prepare-inputs">Prepare inputs</h3>
<p>Before running the workflow, you need to prepare three types of inputs on the cluster's shared storage:</p>
<ol>
<li>Drone imagery datasets (JPEG images)</li>
<li>Metashape configuration files</li>
<li>A config list file specifying which configs to process</li>
</ol>
<p>All inputs must be placed in <code>/ofo-share/argo-data/</code>.</p>
<h4 id="add-drone-imagery-datasets">Add drone imagery datasets</h4>
<p>To add new drone imagery datasets to be processed using Argo, transfer files from your local machine (or the cloud) to the <code>/ofo-share</code> volume. Put the drone imagery datasets to be processed in their own directory in <code>/ofo-share/argo-data/argo-input/datasets</code> (or another folder within <code>argo-input</code>).</p>
<p>One data transfer method is the <code>scp</code> command-line tool:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>scp<span class="w"> </span>-r<span class="w"> </span>&lt;local/directory/drone_image_dataset/&gt;<span class="w"> </span>exouser@&lt;vm.ip.address&gt;:/ofo-share/argo-data/argo-input/datasets
</code></pre></div>
<p>Replace <code>&lt;vm.ip.address&gt;</code> with the IP address of a cluster node that has the share mounted.</p>
<h4 id="specify-metashape-parameters">Specify Metashape parameters</h4>
<div class="admonition warning">
<p class="admonition-title">Config Structure Requirement</p>
<p>The step-based workflow requires an updated config structure with:</p>
<ul>
<li>Global settings under <code>project:</code> section</li>
<li>Each operation as a top-level config section with <code>enabled</code> flag</li>
<li>Separate <code>match_photos</code> and <code>align_cameras</code> sections (not combined <code>alignPhotos</code>)</li>
<li>Separate <code>build_dem</code> and <code>build_orthomosaic</code> sections</li>
</ul>
<p>See the <a href="https://github.com/open-forest-observatory/automate-metashape/blob/main/config/config-example.yml">updated config example</a> for the full structure.</p>
</div>
<p>Metashape processing parameters are specified in configuration YAML files which should be placed somewhere within <code>/ofo-share/argo-data/argo-input</code>.</p>
<p>Every project to be processed needs to have its own standalone configuration file.</p>
<p><strong>Setting the <code>photo_path</code>:</strong> Within the <code>project:</code> section of the config YAML, you must specify <code>photo_path</code> which is
the location of the drone imagery dataset. When running via Argo workflows, this path refers to the
location <strong>inside the docker container</strong>. The <code>/ofo-share/argo-data</code> directory gets mounted at <code>/data</code> inside the container, so for example, if your drone images are at
<code>/ofo-share/argo-data/argo-input/datasets/dataset_1</code>, then the <code>photo_path</code> should be written as:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nt">project</span><span class="p">:</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span><span class="nt">photo_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/argo-input/datasets/dataset_1</span>
</code></pre></div>
<h2 id="downloading-imagery-from-s3-optional">Downloading imagery from S3 (optional)</h2>
<p>Instead of pre-staging imagery on the shared PVC, you can have the workflow automatically download and extract imagery zip files from S3 at runtime. This is useful for:</p>
<ul>
<li><strong>Cloud-native workflows</strong>: Process imagery stored in S3 without manual uploads</li>
<li><strong>One-time processing</strong>: Imagery that doesn't need to persist after the workflow</li>
<li><strong>Remote collaboration</strong>: Team members can trigger workflows without PVC access</li>
</ul>
<h3 id="when-to-use-s3-imagery-download">When to use S3 imagery download</h3>
<p>Use this feature when:</p>
<ul>
<li>Your imagery is already stored as zip files in S3</li>
<li>You want to avoid manual file transfers to the cluster</li>
<li>You're processing imagery that won't be reused</li>
</ul>
<p><strong>Don't use this feature when:</strong></p>
<ul>
<li>Your imagery is already on the PVC (use direct paths instead)</li>
<li>You need to reprocess the same imagery multiple times (pre-staging is more efficient)</li>
<li>Your zip files are very large and bandwidth is a concern</li>
</ul>
<h3 id="configuration">Configuration</h3>
<p>Add the following to the <code>argo:</code> section of your config file:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nt">argo</span><span class="p">:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">  </span><span class="c1"># List of S3 zip files to download (can also be a single string)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span><span class="nt">s3_imagery_zip_download</span><span class="p">:</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ofo-public/drone/missions_01/000558/images/000558_images.zip</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ofo-public/drone/missions_01/000559/images/000559_images.zip</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">  </span><span class="c1"># Whether to delete downloaded imagery after workflow completes (default: true)</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">  </span><span class="nt">cleanup_downloaded_imagery</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>s3_imagery_zip_download</code></td>
<td>S3 path(s) of zip files to download. Can be a single string or a list. Format: <code>bucket/path/file.zip</code>. The S3 endpoint and credentials are configured in the cluster's <code>s3-credentials</code> Kubernetes secret.</td>
<td>(none)</td>
</tr>
<tr>
<td><code>cleanup_downloaded_imagery</code></td>
<td>If <code>true</code>, downloaded imagery is deleted after photogrammetry completes to free disk space</td>
<td><code>true</code></td>
</tr>
</tbody>
</table>
<h3 id="path-syntax-the-__downloaded__-prefix">Path syntax: The <code>__DOWNLOADED__</code> prefix</h3>
<p>When using S3 imagery download, reference downloaded files in <code>photo_path</code> using the <code>__DOWNLOADED__</code> prefix:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="nt">project</span><span class="p">:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">  </span><span class="nt">project_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my_forest_plot</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">  </span><span class="nt">photo_path</span><span class="p">:</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__DOWNLOADED__/000558_images/000558-01</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__DOWNLOADED__/000558_images/000558-02</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__DOWNLOADED__/000559_images/000559-01</span>
</code></pre></div>
<p>The workflow automatically replaces <code>__DOWNLOADED__</code> with the actual download location before photogrammetry begins.</p>
<h3 id="zip-file-structure-requirements">Zip file structure requirements</h3>
<p>The zip filename (without <code>.zip</code> extension) becomes the extraction folder name. Plan your <code>photo_path</code> entries accordingly:</p>
<p><strong>Example:</strong> Downloading <code>000558_images.zip</code> containing:
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>000558_images.zip
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>‚îú‚îÄ‚îÄ 000558-01/
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>‚îÇ   ‚îú‚îÄ‚îÄ IMG_0001.jpg
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>‚îÇ   ‚îî‚îÄ‚îÄ IMG_0002.jpg
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>‚îî‚îÄ‚îÄ 000558-02/
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    ‚îú‚îÄ‚îÄ IMG_0001.jpg
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    ‚îî‚îÄ‚îÄ IMG_0002.jpg
</code></pre></div></p>
<p>Results in this structure after extraction:
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>{download_dir}/
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>‚îî‚îÄ‚îÄ 000558_images/          ‚Üê folder name from zip filename
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    ‚îú‚îÄ‚îÄ 000558-01/
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    ‚îÇ   ‚îú‚îÄ‚îÄ IMG_0001.jpg
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    ‚îÇ   ‚îî‚îÄ‚îÄ IMG_0002.jpg
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    ‚îî‚îÄ‚îÄ 000558-02/
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>        ‚îú‚îÄ‚îÄ IMG_0001.jpg
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>        ‚îî‚îÄ‚îÄ IMG_0002.jpg
</code></pre></div></p>
<p>Reference these paths as:
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nt">photo_path</span><span class="p">:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__DOWNLOADED__/000558_images/000558-01</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__DOWNLOADED__/000558_images/000558-02</span>
</code></pre></div></p>
<h3 id="complete-example-configuration">Complete example configuration</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nt">argo</span><span class="p">:</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">  </span><span class="c1"># S3 imagery download settings</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">  </span><span class="nt">s3_imagery_zip_download</span><span class="p">:</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ofo-public/drone/missions_01/000558/images/000558_images.zip</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">  </span><span class="nt">cleanup_downloaded_imagery</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">  </span><span class="c1"># Standard workflow settings</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">  </span><span class="nt">match_photos</span><span class="p">:</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="nt">gpu_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="nt">gpu_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/mig-1g.5gb&quot;</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;16Gi&quot;</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">  </span><span class="nt">build_depth_maps</span><span class="p">:</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">    </span><span class="nt">gpu_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/mig-2g.10gb&quot;</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="nt">project</span><span class="p">:</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">  </span><span class="nt">project_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mission_000558</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">  </span><span class="c1"># Reference downloaded imagery with __DOWNLOADED__ prefix</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="w">  </span><span class="nt">photo_path</span><span class="p">:</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__DOWNLOADED__/000558_images/000558-01</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">__DOWNLOADED__/000558_images/000558-02</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="c1"># ... rest of Metashape config sections ...</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="nt">match_photos</span><span class="p">:</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="w">  </span><span class="c1"># ...</span>
</code></pre></div>
<h3 id="how-it-works">How it works</h3>
<p>When <code>s3_imagery_zip_download</code> is specified, the workflow adds these steps before photogrammetry:</p>
<ol>
<li><strong>download-imagery</strong>: Downloads each zip file from S3 using rclone and extracts it</li>
<li><strong>transform-config</strong>: Replaces <code>__DOWNLOADED__</code> in <code>photo_path</code> with the actual download location</li>
</ol>
<p>After all processing completes (including upload and postprocessing):</p>
<ol>
<li><strong>cleanup-imagery</strong> (if enabled): Deletes the downloaded imagery to free disk space</li>
</ol>
<p>Each project gets its own isolated download directory to prevent collisions when processing multiple projects in parallel.</p>
<h3 id="troubleshooting-s3-imagery-download">Troubleshooting S3 imagery download</h3>
<h4 id="config-validation-failed-downloaded-prefix-used-but-no-downloads-specified">"Config validation failed: <strong>DOWNLOADED</strong> prefix used but no downloads specified"</h4>
<p><strong>Cause:</strong> Your <code>photo_path</code> contains <code>__DOWNLOADED__</code> but <code>s3_imagery_zip_download</code> is empty or missing.</p>
<p><strong>Solution:</strong> Either add <code>s3_imagery_zip_download</code> entries, or change <code>photo_path</code> to use direct paths (e.g., <code>/data/...</code>).</p>
<h4 id="config-validation-failed-downloads-specified-but-no-downloaded-paths-found">"Config validation failed: Downloads specified but no <strong>DOWNLOADED</strong> paths found"</h4>
<p><strong>Cause:</strong> You specified <code>s3_imagery_zip_download</code> but your <code>photo_path</code> entries don't use the <code>__DOWNLOADED__</code> prefix.</p>
<p><strong>Solution:</strong> Update <code>photo_path</code> to use <code>__DOWNLOADED__/...</code> paths that reference your downloaded zip contents.</p>
<h4 id="download-fails-with-failed-to-copy-or-timeout-errors">Download fails with "Failed to copy" or timeout errors</h4>
<p><strong>Possible causes:</strong></p>
<ul>
<li>Incorrect S3 path format (should be <code>bucket/path/file.zip</code> without a remote prefix)</li>
<li>S3 credentials not configured in the cluster's <code>s3-credentials</code> secret</li>
<li>Network issues or S3 endpoint unavailable</li>
<li>Zip file doesn't exist at the specified path</li>
</ul>
<p><strong>Debug steps:</strong></p>
<ol>
<li>Check the <code>download-imagery</code> step logs in Argo UI</li>
<li>Verify the S3 path is correct by listing files (requires rclone configured with the same credentials):
   <div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>rclone<span class="w"> </span>ls<span class="w"> </span>:s3:ofo-public/drone/missions_01/000558/images/<span class="w"> </span>--s3-provider<span class="o">=</span>Ceph<span class="w"> </span>--s3-endpoint<span class="o">=</span>&lt;endpoint&gt;
</code></pre></div></li>
</ol>
<h4 id="photo-path-not-found-errors-in-setup-step">"Photo path not found" errors in setup step</h4>
<p><strong>Cause:</strong> The extracted zip structure doesn't match your <code>photo_path</code> entries.</p>
<p><strong>Solution:</strong></p>
<ol>
<li>Check what's actually inside your zip file</li>
<li>Ensure <code>photo_path</code> matches the extracted folder structure</li>
<li>Remember: zip filename (minus <code>.zip</code>) becomes the top-level folder</li>
</ol>
<h4 id="disk-space-issues">Disk space issues</h4>
<p><strong>Cause:</strong> Downloaded imagery fills up the shared storage.</p>
<p><strong>Solutions:</strong></p>
<ul>
<li>Ensure <code>cleanup_downloaded_imagery: true</code> (default) to auto-delete after completion</li>
<li>Process fewer projects in parallel to reduce concurrent disk usage</li>
<li>Monitor disk usage during workflow execution</li>
</ul>
<h2 id="resource-request-configuration">Resource request configuration</h2>
<p>All Argo workflow resource requests (GPU, CPU, memory) are configured in the top-level <code>argo</code> section of your automate-metashape config file. The defaults assume one or more JS2 <code>m3.large</code> CPU nodes and one or more <code>mig1</code> (7-slice MIG <code>g3.xl</code>) GPU nodes (see <a href="../cluster-access-and-resizing/">cluster access and resizing</a>).</p>
<p>Importantly, using well-selected resource requests may allow more than one workflow step to schedule simultaneously on the same compute node, without substantially extending the compute time of either, thus greatly increasing compute efficiency by requiring fewer compute nodes. The example config YAML includes suggested resource requests we have developed through extensive benchmarking.</p>
<h3 id="gpu-scheduling">GPU scheduling</h3>
<p>Three steps support configurable GPU usage via <code>argo.&lt;step&gt;.gpu_enabled</code> parameters:</p>
<ul>
<li><code>argo.match_photos.gpu_enabled</code> - If <code>true</code>, runs on GPU node; if <code>false</code>, runs on CPU node (default: <code>true</code>)</li>
<li><code>argo.build_mesh.gpu_enabled</code> - If <code>true</code>, runs on GPU node; if <code>false</code>, runs on CPU node (default: <code>true</code>)</li>
<li><code>argo.match_photos_secondary.gpu_enabled</code> - Inherits from <code>match_photos</code> unless explicitly set</li>
</ul>
<p>The <code>build_depth_maps</code> step always runs on GPU nodes (<code>gpu_enabled</code> cannot be disabled) as it always benefits from GPU acceleration. However, you can configure the GPU resource type and count using <code>gpu_resource</code> and <code>gpu_count</code>.</p>
<h3 id="gpu-resource-selection-mig-support">GPU resource selection (MIG Support)</h3>
<p>For GPU steps, you can specify which GPU resource to request using <code>gpu_resource</code> and <code>gpu_count</code> in the <code>argo</code> section. This allows using MIG (Multi-Instance GPU) partitions instead of full GPUs:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nt">argo</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">  </span><span class="nt">match_photos</span><span class="p">:</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="nt">gpu_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="nt">gpu_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/mig-1g.5gb&quot;</span><span class="w">  </span><span class="c1"># Use smallest MIG partition</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="nt">gpu_count</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w">                           </span><span class="c1"># Request 2 MIG slices for more parallelism</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">  </span><span class="nt">build_depth_maps</span><span class="p">:</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="nt">gpu_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/gpu&quot;</span><span class="w">         </span><span class="c1"># Explicitly request full GPU (this is the default)</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="c1"># gpu_count defaults to 1 if omitted</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">  </span><span class="nt">build_mesh</span><span class="p">:</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="nt">gpu_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">    </span><span class="nt">gpu_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/mig-3g.20gb&quot;</span><span class="w"> </span><span class="c1"># Larger MIG partition for mesh building</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">    </span><span class="nt">gpu_count</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</code></pre></div>
<p>Available GPU resources:</p>
<table>
<thead>
<tr>
<th>Resource</th>
<th>Description</th>
<th>Pods per GPU</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>nvidia.com/gpu</code></td>
<td>Full GPU (default if <code>gpu_resource</code> omitted)</td>
<td>1</td>
</tr>
<tr>
<td><code>nvidia.com/mig-1g.5gb</code></td>
<td>1/7 compute, 5GB VRAM</td>
<td>7</td>
</tr>
<tr>
<td><code>nvidia.com/mig-2g.10gb</code></td>
<td>2/7 compute, 10GB VRAM</td>
<td>3</td>
</tr>
<tr>
<td><code>nvidia.com/mig-3g.20gb</code></td>
<td>3/7 compute, 20GB VRAM</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>Use <code>gpu_count</code> to request multiple MIG slices (e.g., <code>gpu_count: 2</code> with <code>mig-1g.5gb</code> to get 2/7 compute power).</p>
<div class="admonition tip">
<p class="admonition-title">When to use MIG</p>
<p>Use MIG partitions when your GPU steps have low utilization. This allows multiple workflow steps to share a single physical GPU, reducing costs. In extensive benchmarking, we have found that we get the greatest efficiency with mig-1g.5gb nodes, potentially providing more than one slice to GPU-intensive pods.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Nodegroup requirement</p>
<p>MIG resources are only available on MIG-enabled nodegroups. Create a MIG nodegroup with a name containing <code>mig1-</code>, <code>mig2-</code>, or <code>mig3-</code> (see <a href="../cluster-access-and-resizing/#mig-nodegroups">MIG nodegroups</a>).</p>
</div>
<h3 id="cpu-and-memory-configuration">CPU and memory configuration</h3>
<p>You can configure CPU and memory requests for all workflow steps (both CPU and GPU steps) using <code>cpu_request</code> and <code>memory_request</code> parameters in the <code>argo</code> section:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nt">argo</span><span class="p">:</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">  </span><span class="c1"># Optional: Set global defaults that apply to all steps</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">  </span><span class="nt">defaults</span><span class="p">:</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10&quot;</span><span class="w">        </span><span class="c1"># Default CPU cores for all steps</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;50Gi&quot;</span><span class="w">   </span><span class="c1"># Default memory for all steps</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">  </span><span class="c1"># Override for specific steps</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">  </span><span class="nt">match_photos</span><span class="p">:</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8&quot;</span><span class="w">         </span><span class="c1"># Override default CPU request for this step</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;32Gi&quot;</span><span class="w">   </span><span class="c1"># Override default memory request for this step</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">  </span><span class="nt">build_depth_maps</span><span class="p">:</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;6&quot;</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;24Gi&quot;</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">  </span><span class="nt">align_cameras</span><span class="p">:</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;15&quot;</span><span class="w">        </span><span class="c1"># CPU-heavy step</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;50Gi&quot;</span>
</code></pre></div>
<p>Default values (if not specified) are hard-coded into the workflow YAML under the CPU and GPU step templates.</p>
<p><strong>Fallback order:</strong></p>
<ol>
<li>Step-specific value (e.g., <code>argo.match_photos.cpu_request</code>)</li>
<li>User default from <code>argo.defaults</code> (if specified)</li>
<li>Hardcoded default (based on step type and GPU mode)</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Using defaults as a template</p>
<p>You can leave step-level parameters blank/empty to use the defaults, which serves as a visual template:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="nt">argo</span><span class="p">:</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">  </span><span class="nt">defaults</span><span class="p">:</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8&quot;</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;40Gi&quot;</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">  </span><span class="nt">match_photos</span><span class="p">:</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w">      </span><span class="c1"># Blank = uses defaults.cpu_request ‚Üí 8</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w">   </span><span class="c1"># Blank = uses defaults.memory_request ‚Üí 40Gi</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">  </span><span class="nt">build_depth_maps</span><span class="p">:</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;12&quot;</span><span class="w"> </span><span class="c1"># Override: uses 12 instead of defaults</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w">   </span><span class="c1"># Blank = uses defaults.memory_request ‚Üí 40Gi</span>
</code></pre></div>
</div>
<h3 id="secondary-photo-processing">Secondary photo processing</h3>
<p>The <code>match_photos_secondary</code> and <code>align_cameras_secondary</code> steps <strong>inherit resource configuration</strong> from their primary steps unless explicitly overridden:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nt">argo</span><span class="p">:</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">  </span><span class="nt">match_photos</span><span class="p">:</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="nt">gpu_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/mig-2g.10gb&quot;</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;6&quot;</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;24Gi&quot;</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">  </span><span class="c1"># match_photos_secondary automatically inherits the above settings</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">  </span><span class="c1"># unless you override them:</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">  </span><span class="nt">match_photos_secondary</span><span class="p">:</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="nt">gpu_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/mig-1g.5gb&quot;</span><span class="w">  </span><span class="c1"># Override: use smaller GPU</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">    </span><span class="c1"># cpu_request and memory_request still inherited from match_photos</span>
</code></pre></div>
<p>This 4-level fallback applies: Secondary-specific ‚Üí Primary step ‚Üí User defaults ‚Üí Hardcoded defaults</p>
<p><strong>Parameters handled by Argo:</strong> The <code>project_path</code>, <code>output_path</code>, and <code>project_name</code> configuration parameters are handled automatically by the Argo workflow:</p>
<ul>
<li><code>project_path</code> and <code>output_path</code> are determined via CLI arguments passed to the automate-metashape container, derived from the <code>TEMP_WORKING_DIR</code> Argo workflow parameter (passed by the user on the command line when invoking <code>argo submit</code>)</li>
<li><code>project_name</code> is extracted from <code>project.project_name</code> in the config file (or from the filename
  of the config file if missing in the config) and passed by Argo via CLI to each step to ensure consistent project names per mission</li>
</ul>
<p>Any values specified for <code>project_path</code> and <code>output_path</code> in the config.yml will be overridden by Argo CLI arguments.</p>
<h4 id="create-a-config-list-file">Create a config list file</h4>
<p>We use a text file, for example <code>config-list.txt</code>, to tell the Argo workflow which config files
should be processed in the current run. Place this file in the <strong>same directory as your config files</strong>, then list just the <strong>filenames</strong> (not full paths), one per line.</p>
<p><strong>Example:</strong> If your configs are in <code>/ofo-share/argo-data/argo-input/configs/</code>, create a file at <code>/ofo-share/argo-data/argo-input/configs/config-list.txt</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a># Benchmarking missions
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>01_benchmarking-greasewood.yml
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>02_benchmarking-greasewood.yml
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a># Skipping emerald for now
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a># 01_benchmarking-emerald-subset.yml
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a># 02_benchmarking-emerald-subset.yml
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>03_production-run.yml  # high priority
</code></pre></div>
<p><strong>Features:</strong></p>
<ul>
<li><strong>Filenames only</strong>: List just the config filename; the directory is inferred from the config list's location</li>
<li><strong>Comments</strong>: Lines starting with <code>#</code> (after whitespace) are skipped</li>
<li><strong>Inline comments</strong>: Text after <code>#</code> on any line is ignored (e.g., <code>config.yml # note</code>)</li>
<li><strong>Blank lines</strong>: Empty lines are ignored for readability</li>
<li><strong>Backward compatibility</strong>: Absolute paths (starting with <code>/</code>) still work if needed</li>
</ul>
<p>The project name will be automatically derived from the config filename (e.g., <code>project-name.yml</code> becomes project <code>project-name</code>), unless explicitly set in the config file at <code>project.project_name</code> (which takes priority).</p>
<p>You can create your own config list file and name it whatever you want, placing it anywhere within <code>/ofo-share/argo-data/</code>. Then specify the path to it within the container (using <code>/data/XYZ</code> to refer to <code>/ofo-share/argo-data/XYZ</code>) using the <code>CONFIG_LIST</code> parameter when submitting the workflow.</p>
<h3 id="determine-the-maximum-number-of-projects-to-process-in-parallel">Determine the maximum number of projects to process in parallel</h3>
<p>When tasked with parallelizing across multiple multi-step DAGs, Argo prioritizes breadth first. So
when it has a choice, it will start on a new DAG (metashape project) rather than starting the next
step of an existing one. This is unfortunately not customizable, and it is undesirable because the
workflow involves storing in-process files (including raw imagery, metashape project, outputs)
locally during processing. Our shared storage does not have the space to store all files locally at
the same time. In addition, we have a limited number of Metashape licenses. So we need to restrict
the number of parallel DAGs (metashape projects) it will attempt to run.</p>
<p>The workflow controls this via the <code>parallelism</code> field in the <code>main</code> template (line 66 in
<code>photogrammetry-workflow-stepbased.yaml</code>). <strong>To change the max parallel projects, edit this value
directly in the workflow file before submitting.</strong> The default is set to <code>10</code>.</p>
<div class="admonition note">
<p class="admonition-title">Why not a command-line parameter?</p>
<p>Argo Workflows doesn't support parameter substitution for integer fields like <code>parallelism</code>,
so this value must be hardcoded in the workflow file. This is an <a href="https://github.com/argoproj/argo-workflows/issues/1780">known issue</a> with Argo and we
should look for it to be resovled so we can implement it as a command line parameter.</p>
</div>
<h3 id="adjusting-parallelism-on-a-running-workflow">Adjusting parallelism on a running workflow</h3>
<p>If you need to increase or decrease parallelism while a workflow is already running, you can patch
the workflow in place. First, find your workflow name:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>argo<span class="w"> </span>list<span class="w"> </span>-n<span class="w"> </span>argo
</code></pre></div>
<p>Then patch the <code>main</code> template's parallelism (index 0):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>kubectl<span class="w"> </span>patch<span class="w"> </span>workflow<span class="w"> </span>&lt;workflow-name&gt;<span class="w"> </span>-n<span class="w"> </span>argo<span class="w"> </span>--type<span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">  </span>-p<span class="o">=</span><span class="s1">&#39;[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/templates/0/parallelism&quot;, &quot;value&quot;: 20}]&#39;</span>
</code></pre></div>
<p>The change takes effect immediately for any new pods that haven't started yet. Already-running pods
are not affected.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This only affects the running workflow instance. Future submissions will still use the value
from the YAML file.</p>
</div>
<h2 id="submit-the-workflow">Submit the workflow</h2>
<p>Once your cluster authentication is set up and your inputs are prepared, run:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>argo<span class="w"> </span>submit<span class="w"> </span>-n<span class="w"> </span>argo<span class="w"> </span>photogrammetry-workflow-stepbased.yaml<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">  </span>--name<span class="w"> </span><span class="s2">&quot;my-run-</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">  </span>-p<span class="w"> </span><span class="nv">CONFIG_LIST</span><span class="o">=</span>/data/argo-input/configs/config-list.txt<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">  </span>-p<span class="w"> </span><span class="nv">TEMP_WORKING_DIR</span><span class="o">=</span>/data/argo-output/tmp/derek-0202<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">  </span>-p<span class="w"> </span><span class="nv">S3_BUCKET_INTERNAL</span><span class="o">=</span>ofo-internal<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">  </span>-p<span class="w"> </span><span class="nv">S3_PHOTOGRAMMETRY_DIR</span><span class="o">=</span>photogrammetry-outputs_dytest02<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">  </span>-p<span class="w"> </span><span class="nv">PHOTOGRAMMETRY_CONFIG_ID</span><span class="o">=</span><span class="m">03</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">  </span>-p<span class="w"> </span><span class="nv">S3_BUCKET_PUBLIC</span><span class="o">=</span>ofo-public<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">  </span>-p<span class="w"> </span><span class="nv">S3_POSTPROCESSED_DIR</span><span class="o">=</span>drone_dytest02<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">  </span>-p<span class="w"> </span><span class="nv">S3_BOUNDARY_DIR</span><span class="o">=</span>drone_dytest02<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">  </span>-p<span class="w"> </span><span class="nv">OFO_ARGO_IMAGES_TAG</span><span class="o">=</span>latest<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">  </span>-p<span class="w"> </span><span class="nv">AUTOMATE_METASHAPE_IMAGE_TAG</span><span class="o">=</span>latest
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Workflow File</p>
<p>Note the different workflow file: <code>photogrammetry-workflow-stepbased.yaml</code> instead of <code>photogrammetry-workflow.yaml</code></p>
</div>
<p>Database parameters (not currently functional):
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>-p<span class="w"> </span><span class="nv">DB_PASSWORD</span><span class="o">=</span>&lt;password&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>-p<span class="w"> </span><span class="nv">DB_HOST</span><span class="o">=</span>&lt;vm_ip_address&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>-p<span class="w"> </span><span class="nv">DB_NAME</span><span class="o">=</span>&lt;db_name&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>-p<span class="w"> </span><span class="nv">DB_USER</span><span class="o">=</span>&lt;user_name&gt;
</code></pre></div></p>
<h3 id="workflow-parameters">Workflow parameters</h3>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CONFIG_LIST</code></td>
<td><strong>Absolute path</strong> to text file listing metashape config files. Each line should be a config filename (resolved relative to the config list's directory) or an absolute path. Lines starting with <code>#</code> are comments. Example: <code>/data/argo-input/configs/config-list.txt</code></td>
</tr>
<tr>
<td><code>TEMP_WORKING_DIR</code></td>
<td><strong>Absolute path</strong> for temporary workflow files (both photogrammetry and postprocessing). Workflow creates <code>{workflow-name}/{iteration-id}/</code> subdirectories automatically for each mission. Iteration directories are automatically deleted after successful postprocessing to free disk space. Example: <code>/data/argo-output/temp-runs/gillan_june27</code></td>
</tr>
<tr>
<td><code>PHOTOGRAMMETRY_CONFIG_ID</code></td>
<td>Two-digit configuration ID (e.g., <code>01</code>, <code>02</code>) used to organize outputs into <code>photogrammetry_NN</code> subdirectories in S3 for both raw and postprocessed products. If not specified or set to <code>NONE</code>, both raw and postprocessed products are stored without the <code>photogrammetry_NN</code> subfolder.</td>
</tr>
<tr>
<td><code>S3_BUCKET_INTERNAL</code></td>
<td>S3 bucket for internal/intermediate outputs where raw Metashape products (orthomosaics, point clouds, DEMs) are uploaded (typically <code>ofo-internal</code>).</td>
</tr>
<tr>
<td><code>S3_PHOTOGRAMMETRY_DIR</code></td>
<td>S3 directory name for raw Metashape outputs. When <code>PHOTOGRAMMETRY_CONFIG_ID</code> is set, products upload to <code>{S3_BUCKET_INTERNAL}/{S3_PHOTOGRAMMETRY_DIR}/photogrammetry_{PHOTOGRAMMETRY_CONFIG_ID}/</code>. When <code>PHOTOGRAMMETRY_CONFIG_ID</code> is not set, products go to <code>{bucket}/{S3_PHOTOGRAMMETRY_DIR}/</code>. Example: <code>photogrammetry-outputs</code></td>
</tr>
<tr>
<td><code>S3_BUCKET_PUBLIC</code></td>
<td>S3 bucket for public/final outputs (postprocessed, clipped products ready for distribution) and where boundary files are stored (typically <code>ofo-public</code>).</td>
</tr>
<tr>
<td><code>S3_POSTPROCESSED_DIR</code></td>
<td>S3 directory name for postprocessed outputs. When <code>PHOTOGRAMMETRY_CONFIG_ID</code> is set, products are organized as <code>{S3_POSTPROCESSED_DIR}/{mission_name}/photogrammetry_{PHOTOGRAMMETRY_CONFIG_ID}/</code>. When not set, products go to <code>{S3_POSTPROCESSED_DIR}/{mission_name}/</code>. Example: <code>drone/missions_03</code></td>
</tr>
<tr>
<td><code>S3_BOUNDARY_DIR</code></td>
<td>Parent directory in <code>S3_BUCKET_PUBLIC</code> where mission boundary polygons reside (used to clip imagery). The structure beneath this directory is assumed to be: <code>&lt;S3_BOUNDARY_DIR&gt;/&lt;mission_name&gt;/metadata-mission/&lt;mission_name&gt;_mission-metadata.gpkg</code>. Example: <code>drone/missions_03</code></td>
</tr>
<tr>
<td><code>OFO_ARGO_IMAGES_TAG</code></td>
<td>Docker image tag for OFO Argo containers (postprocessing and argo-workflow-utils) (default: <code>latest</code>). Use a specific branch name or tag to test development versions (e.g., <code>dy-manila</code>)</td>
</tr>
<tr>
<td><code>AUTOMATE_METASHAPE_IMAGE_TAG</code></td>
<td>Docker image tag for the automate-metashape container (default: <code>latest</code>). Use a specific branch name or tag to test development versions</td>
</tr>
<tr>
<td><code>DB_*</code></td>
<td>Database parameters for logging Argo status (not currently functional; credentials in <a href="https://docs.google.com/document/d/155AP0P3jkVa-yT53a-QLp7vBAfjRa78gdST1Dfb4fls/edit?tab=t.0">OFO credentials document</a>)</td>
</tr>
</tbody>
</table>
<p><strong>Secrets configuration:</strong></p>
<ul>
<li><strong>S3 credentials</strong>: S3 access credentials, provider type, and endpoint URL are configured via the <code>s3-credentials</code> Kubernetes secret</li>
<li><strong>Agisoft license</strong>: Metashape floating license server address is configured via the
  <code>agisoft-license</code> Kubernetes secret</li>
</ul>
<p>These secrets should have been created (within the <code>argo</code> namespace) during <a href="../../admin/cluster-creation-and-resizing/">cluster creation</a>.</p>
<h2 id="monitor-the-workflow">Monitor the workflow</h2>
<h3 id="using-the-argo-ui">Using the Argo UI</h3>
<p>The Argo UI is great for troubleshooting and checking individual step progress. Access it at <a href="https://argo.focal-lab.org">argo.focal-lab.org</a>, using the credentials from <a href="https://vault.focal-lab.org">Vaultwarden</a> under the record "Argo UI token".</p>
<h4 id="navigating-the-argo-ui">Navigating the Argo UI</h4>
<p>The <strong>Workflows</strong> tab on the left side menu shows all running workflows. Click a workflow to see a detailed DAG (directed acyclic graph) showing:</p>
<ul>
<li><strong>Preprocessing task</strong>: The <code>determine-projects</code> step that reads config files</li>
<li><strong>Per-mission columns</strong>: Each mission shows as a separate column with all its processing steps</li>
<li><strong>Individual step status</strong>: Each of the 10+ steps shown with color-coded status</li>
</ul>
<p><strong>Step status colors:</strong></p>
<ul>
<li>üü¢ <strong>Green (Succeeded)</strong>: Step completed successfully</li>
<li>üîµ <strong>Blue (Running)</strong>: Step currently executing</li>
<li>‚ö™ <strong>Gray (Skipped)</strong>: Step was disabled in config or conditionally skipped</li>
<li>üî¥ <strong>Red (Failed)</strong>: Step encountered an error</li>
<li>üü° <strong>Yellow (Pending)</strong>: Step waiting for dependencies</li>
</ul>
<p>Click on a specific step to see detailed information including:</p>
<ul>
<li>Which VM/node it's running on (CPU vs GPU node)</li>
<li>Duration of the step</li>
<li>Real-time logs</li>
<li>Resource usage</li>
<li>Input/output parameters</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Viewing Step Logs</p>
<p>To view logs for a specific step:</p>
<ol>
<li>Click the workflow in Argo UI</li>
<li>Click on the individual step node (e.g., <code>match-photos-gpu</code>, <code>build-depth-maps</code>)</li>
<li>Click the "Logs" tab</li>
<li>Logs will stream in real-time if the step is running</li>
</ol>
</div>
<h4 id="multi-mission-miew">Multi-mission miew</h4>
<p>When processing multiple missions, the Argo UI shows all missions side-by-side. This makes it easy to:</p>
<ul>
<li>See which missions are at which step</li>
<li>Identify if one mission is failing while others succeed</li>
<li>Compare processing times across missions</li>
<li>Monitor overall workflow progress</li>
</ul>
<h4 id="understanding-step-names">Understanding step names</h4>
<p>Task names in the Argo UI follow the pattern <code>process-projects-N.&lt;step-name&gt;</code>:</p>
<ul>
<li><code>process-projects-0.setup</code> - Setup step for first mission (index 0)</li>
<li><code>process-projects-0.match-photos-gpu</code> - Match photos on GPU for first mission</li>
<li><code>process-projects-1.build-depth-maps</code> - Build depth maps for second mission (index 1)</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Finding Your Mission</p>
<p>To identify which mission corresponds to which index:</p>
<ol>
<li>Check the <code>determine-projects</code> step logs to see the order of missions in the JSON output</li>
<li>Click on any task (e.g., <code>process-projects-0.setup</code>) and view the parameters to see the <code>project-name</code> value</li>
<li>The project name appears in all file paths, logs, and processing outputs</li>
</ol>
</div>
<p>GPU-capable steps show either <code>-gpu</code> or <code>-cpu</code> suffix depending on config.</p>
<h3 id="using-the-cli">Using the CLI</h3>
<p>View workflow status from the command line:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># Watch overall workflow progress</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>argo<span class="w"> </span>watch<span class="w"> </span>&lt;workflow-name&gt;
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="c1"># List all workflows</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>argo<span class="w"> </span>list
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="c1"># Get logs for preprocessing step</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>argo<span class="w"> </span>logs<span class="w"> </span>&lt;workflow-name&gt;<span class="w"> </span>-c<span class="w"> </span>determine-projects
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="c1"># Get logs for a specific mission&#39;s step</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="c1"># Format: process-projects-&lt;N&gt;.&lt;step-name&gt;</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>argo<span class="w"> </span>logs<span class="w"> </span>&lt;workflow-name&gt;<span class="w"> </span>-c<span class="w"> </span>process-projects-0.setup
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>argo<span class="w"> </span>logs<span class="w"> </span>&lt;workflow-name&gt;<span class="w"> </span>-c<span class="w"> </span>process-projects-0.match-photos-gpu
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>argo<span class="w"> </span>logs<span class="w"> </span>&lt;workflow-name&gt;<span class="w"> </span>-c<span class="w"> </span>process-projects-1.build-depth-maps
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="c1"># Follow logs in real-time</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>argo<span class="w"> </span>logs<span class="w"> </span>&lt;workflow-name&gt;<span class="w"> </span>-c<span class="w"> </span>process-projects-0.setup<span class="w"> </span>-f
</code></pre></div>
<h2 id="workflow-outputs">Workflow outputs</h2>
<p>The final outputs will be written to <code>S3:ofo-public</code> in the following directory structure:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>/S3:ofo-public/
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>‚îú‚îÄ‚îÄ<span class="w"> </span>&lt;OUTPUT_DIRECTORY&gt;/
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1/
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">         </span>‚îú‚îÄ‚îÄ<span class="w"> </span>images/
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">         </span>‚îú‚îÄ‚îÄ<span class="w"> </span>metadata-images/
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">         </span>‚îú‚îÄ‚îÄ<span class="w"> </span>metadata-mission/
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">            </span>‚îî‚îÄ‚îÄ<span class="w"> </span>dataset1_mission-metadata.gpkg
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">         </span>‚îú‚îÄ‚îÄphotogrammetry_01/
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">            </span>‚îú‚îÄ‚îÄ<span class="w"> </span>full/
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_cameras.xml
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_chm-ptcloud.tif
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_dsm-ptcloud.tif
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_dtm-ptcloud.tif
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_log.txt
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_ortho-dtm-ptcloud.tif
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_points.copc.laz
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">               </span>‚îî‚îÄ‚îÄ<span class="w"> </span>dataset1_report.pdf
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="w">            </span>‚îú‚îÄ‚îÄ<span class="w"> </span>thumbnails/
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_chm-ptcloud.png
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_dsm-ptcloud.png
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_dtm-ptcloud.png
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="w">               </span>‚îî‚îÄ‚îÄ<span class="w"> </span>dataset1-ortho-dtm-ptcloud.png
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="w">         </span>‚îú‚îÄ‚îÄphotogrammetry_02/
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="w">            </span>‚îú‚îÄ‚îÄ<span class="w"> </span>full/
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_cameras.xml
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_chm-ptcloud.tif
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_dsm-ptcloud.tif
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_dtm-ptcloud.tif
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_log.txt
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_ortho-dtm-ptcloud.tif
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_points.copc.laz
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a><span class="w">               </span>‚îî‚îÄ‚îÄ<span class="w"> </span>dataset1_report.pdf
<a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a><span class="w">            </span>‚îú‚îÄ‚îÄ<span class="w"> </span>thumbnails/
<a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_chm-ptcloud.png
<a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_dsm-ptcloud.png
<a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a><span class="w">               </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset1_dtm-ptcloud.png
<a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a><span class="w">               </span>‚îî‚îÄ‚îÄ<span class="w"> </span>dataset1-ortho-dtm-ptcloud.png
<a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a><span class="w">    </span>‚îú‚îÄ‚îÄ<span class="w"> </span>dataset2/
</code></pre></div>
<p>This directory structure should already exist prior to running the Argo workflow.</p>
<!-- Commenting out the AI-generated troubleshooting section since it may be misleading or not current.
## Troubleshooting

### Steps are skipped even though they should run

**Check:**

1. Verify the step's `enabled` flag is `true` in the config file
2. For `build_dem_orthomosaic`, verify either `build_dem.enabled` OR `build_orthomosaic.enabled` is `true`
3. For secondary photo steps, verify `project.photo_path_secondary` is set to a non-empty path
4. Check preprocessing logs to see what parameters were extracted:

<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>argo<span class="w"> </span>logs<span class="w"> </span>&lt;workflow-name&gt;<span class="w"> </span>-c<span class="w"> </span>determine-datasets
</code></pre></div>

### Step fails with "Prerequisites not met"

**Cause:** A required previous step was skipped or failed.

**Solution:**

1. Check the error message to see which prerequisite is missing
2. Verify the previous step's config is enabled
3. Check previous step logs for failures

**Common prerequisites:**

- `align_cameras` requires `match_photos` to have created tie points
- `build_depth_maps` requires `align_cameras` to have aligned cameras
- `build_point_cloud` requires `build_depth_maps` to have created depth maps
- `build_dem_orthomosaic` requires either `build_point_cloud` or `build_mesh` to have run

### GPU steps running on CPU nodes (or vice versa)

**Check:**

1. Verify `argo.<step>.gpu_enabled` parameter in config is a boolean (`true` or `false`), not a string
2. Check preprocessing output to confirm correct `use_gpu` parameter was extracted:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>argo<span class="w"> </span>logs<span class="w"> </span>&lt;workflow-name&gt;<span class="w"> </span>-c<span class="w"> </span>determine-datasets
</code></pre></div>
3. Verify cluster has GPU nodes available and properly labeled (`nvidia.com/gpu.present=true`)
4. Verify the GPU step template has the correct GPU resource request

### MIG pods not scheduling

**Check:**

1. Verify nodegroup name includes `mig1-`, `mig2-`, or `mig3-`
2. Verify the MIG NodeFeatureRule is applied: `kubectl get nodefeaturerule mig-nodegroup-labels`
3. Check node has correct MIG label: `kubectl get node <name> -o yaml | grep mig.config`
4. Check MIG resources are available: `kubectl describe node <name> | grep mig`
5. Verify workflow requests correct MIG resource type (e.g., `nvidia.com/mig-2g.10gb`)

### Project file not found in later steps

**Cause:** The `setup` step failed or project file was not saved correctly.

**Solution:**

1. Check `setup` step logs for errors
2. Verify `project_path` is correctly set
3. Ensure shared storage (`/ofo-share`) is mounted correctly
4. Verify `project.project_name` is set in config file

### Config file parsing errors in preprocessing

**Common issues:**

- YAML syntax errors (indentation, missing colons)
- Config file path in `CONFIG_LIST` is incorrect
- Config file doesn't exist at specified path
- Missing required fields (`project.project_name`, `project.photo_path`)

**Debug:**

<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># Check preprocessing logs</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>argo<span class="w"> </span>logs<span class="w"> </span>&lt;workflow-name&gt;<span class="w"> </span>-c<span class="w"> </span>determine-datasets
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="c1"># Manually validate config YAML</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import yaml; yaml.safe_load(open(&#39;/ofo-share/argo-data/argo-input/configs/mission.yml&#39;))&quot;</span>
</code></pre></div>

### Out of memory errors

**Solutions:**

1. Reduce dataset size or processing quality settings
2. Increase memory limits in workflow templates
3. For large datasets, ensure you're using GPU for `match_photos` and `build_depth_maps`
4. Check cluster node resources and ensure sufficient memory per node

### Performance optimization tips

**For small datasets (<100 images):**

<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nt">match_photos</span><span class="p">:</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">  </span><span class="c1"># ... match_photos parameters</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="nt">argo</span><span class="p">:</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">  </span><span class="nt">match_photos</span><span class="p">:</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">    </span><span class="nt">gpu_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># CPU is sufficient, saves cost</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;18&quot;</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;100Gi&quot;</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="w">  </span><span class="nt">build_mesh</span><span class="p">:</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="w">    </span><span class="c1"># Skip mesh generation if not needed (set enabled: false in build_mesh section)</span>
</code></pre></div>

**For large datasets (>500 images):**

<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nt">match_photos</span><span class="p">:</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">  </span><span class="c1"># ... match_photos parameters</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="nt">build_depth_maps</span><span class="p">:</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">  </span><span class="c1"># ... depth maps parameters</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="nt">build_mesh</span><span class="p">:</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">  </span><span class="c1"># ... mesh parameters</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="nt">argo</span><span class="p">:</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="w">  </span><span class="nt">match_photos</span><span class="p">:</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="w">    </span><span class="nt">gpu_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># GPU recommended</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="w">    </span><span class="nt">gpu_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/mig-2g.10gb&quot;</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;16Gi&quot;</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="w">  </span><span class="nt">build_depth_maps</span><span class="p">:</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="w">    </span><span class="c1"># Always uses GPU</span>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="w">    </span><span class="nt">gpu_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/gpu&quot;</span><span class="w">  </span><span class="c1"># Use full GPU for large datasets</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;16Gi&quot;</span>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="w">  </span><span class="nt">build_mesh</span><span class="p">:</span>
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="w">    </span><span class="nt">gpu_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># GPU recommended for large meshes</span>
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="w">    </span><span class="nt">gpu_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/mig-2g.10gb&quot;</span>
</code></pre></div>

**Cost optimization:**

<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># Minimize GPU usage where possible</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="nt">argo</span><span class="p">:</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">  </span><span class="nt">defaults</span><span class="p">:</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">    </span><span class="nt">gpu_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/mig-1g.5gb&quot;</span><span class="w">  </span><span class="c1"># Use smallest MIG by default</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">  </span><span class="nt">match_photos</span><span class="p">:</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">    </span><span class="nt">gpu_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># Use CPU for small datasets</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;18&quot;</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;100Gi&quot;</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">  </span><span class="nt">build_depth_maps</span><span class="p">:</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">    </span><span class="nt">gpu_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/mig-2g.10gb&quot;</span><span class="w">  </span><span class="c1"># Smaller GPU for depth maps</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">    </span><span class="nt">cpu_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">    </span><span class="nt">memory_request</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;16Gi&quot;</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="c1"># In step sections:</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="nt">build_mesh</span><span class="p">:</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># Skip mesh generation if not needed</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="nt">build_point_cloud</span><span class="p">:</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="w">  </span><span class="nt">remove_after_export</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># Cleanup happens in finalize step</span>
</code></pre></div>
-->

<!--

## Argo Workflow Logging in PostGIS Database

**THE DB LOGGING IS CURRENTLY DISABLED AND IS BEING MIGRATED TO A HOSTED SOLUTION THROUGH SUPABASE**

Argo run status is logged into a PostGIS DB. This is done through an additional docker container (hosted on GitHub Container Registry `ghcr.io/open-forest-observatory/argo-workflow-utils:latest`) that is included in the argo workflow. The files to make the docker image are in the folder `argo-workflow-utils`.

### Info on the PostGIS DB

There is a JS2 VM called `ofo-postgis` that hosts a PostGIS DB for storing metadata of argo workflows.

You can access the `ofo-postgis` VM through Webshell in Exosphere. Another access option is to SSH into `ofo-postgis` with the command `ssh exouser@<ip_address>`. This is not public and will require a password.

The DB is running in a docker container (`postgis/postgis`). The DB storage is a 10 GB volume at `/media/volume/ofo-postgis` on the VM.

### Steps to View the Logged Results

Enter the Docker container running the PostGIS server:
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>sudo<span class="w"> </span>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-ti<span class="w"> </span>ofo-postgis<span class="w"> </span>bash
</code></pre></div>

Launch the PostgreSQL CLI as the intended user (grab from DB credentials):
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>psql<span class="w"> </span>-U<span class="w"> </span>postgres
</code></pre></div>

List all tables in the database:
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>\dt
</code></pre></div>

Show the structure of a specific table (column names & data types):
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>\d automate_metashape
</code></pre></div>

Currently, the PostGIS server stores the following keys in the `automate_metashape` table:

| **Column**   | **Type** | **Description**  |
|  --- | ----  | --- |
|id | integer | unique identifier for each call of automate-metashape (not run) |
|dataset_name | character varying(100) | project running for the individual call of automate-metashape (column name is legacy) |
| workflow_id | character varying(100) | identifier for run of ofo-argo |
| status | character varying(50)  | either queued, processing, failed or completed, based on current and final status of automate-metashape |
| start_time | timestamp without time zone | start time of automate-metashape run |
| finish_time  | timestamp without time zone | end time of automate-metashape run (if it was able to finish) |
| created_at | timestamp without time zone | creation time of entry in database |

View all data records for a specific table:
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">automate_metashape</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</code></pre></div>

![SQL query results](https://github.com/user-attachments/assets/cba4532a-21de-4c35-8b2d-635eec326ef7)

Exit out of psql command-line:
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>\q
</code></pre></div>

Exit out of container:
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="nb">exit</span>
</code></pre></div>

### Other useful commands

View all running and stopped containers:
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>docker<span class="w"> </span>ps<span class="w"> </span>-a
</code></pre></div>

Stop a running container:
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>docker<span class="w"> </span>stop<span class="w"> </span>&lt;container_id&gt;
</code></pre></div>

Remove container:
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>docker<span class="w"> </span>rm<span class="w"> </span>&lt;container_id&gt;
</code></pre></div>

Run the docker container DB:
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>sudo<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>--name<span class="w"> </span>ofo-postgis<span class="w">   </span>-e<span class="w"> </span><span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span>ujJ1tsY9OizN0IpOgl1mY1cQGvgja3SI<span class="w">   </span>-p<span class="w"> </span><span class="m">5432</span>:5432<span class="w">   </span>-v<span class="w"> </span>/media/volume/ofo-postgis/data:/var/lib/postgresql/data<span class="w">  </span>-d<span class="w"> </span>postgis/postgis
</code></pre></div>

### Github action to rebuild DB logging docker image

There is a GitHub action workflow that rebuilds the logging docker image if any changes have been made at all in the repo. This workflow is in the directory `.github/workflows`. **The workflow is currently disabled in the 'Actions' section of the repository.**

-->







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../photogrammetry-workflow/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Running the photogrammetry workflow">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Running the photogrammetry workflow
              </div>
            </div>
          </a>
        
        
          
          <a href="../stepbased-quick-reference/" class="md-footer__link md-footer__link--next" aria-label="Next: Step-based workflow quick reference">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Step-based workflow quick reference
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.footer", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>