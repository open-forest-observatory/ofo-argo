
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://open-forest-observatory.github.io/ofo-argo/admin/cluster-creation-and-resizing/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../manila-share-mounting/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Cluster creation and resizing - OFO Argo Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cluster-creation-and-resizing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OFO Argo Documentation" class="md-header__button md-logo" aria-label="OFO Argo Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OFO Argo Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cluster creation and resizing
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OFO Argo Documentation" class="md-nav__button md-logo" aria-label="OFO Argo Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    OFO Argo Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OFO Argo Workflows Documentation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../usage/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    User guides
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    User guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/cluster-access-and-resizing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cluster access and resizing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/argo-usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Using Argo on the OFO cluster
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/photogrammetry-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Running the photogrammetry workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/stepbased-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Running the step-based photogrammetry workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/stepbased-quick-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step-based workflow quick reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Administrator guides
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Administrator guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Cluster creation and resizing
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Cluster creation and resizing
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#one-time-local-machine-software-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        One-time local machine software setup
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="One-time local machine software setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-python-and-create-virtual-environment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install Python and create virtual environment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-openstack-command-line-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install OpenStack command line tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-kubectl" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install kubectl
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-application-credential" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create application credential
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-openstack-keypair" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create OpenStack keypair
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-shell-completion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enable shell completion
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-creation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cluster creation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cluster creation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view-available-cluster-templates" class="md-nav__link">
    <span class="md-ellipsis">
      
        View available cluster templates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-the-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deploy the cluster
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up-kubectl-to-control-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Set up kubectl to control Kubernetes
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-argo-namespace" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the Argo namespace
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-kubernetes-secrets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create Kubernetes secrets
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create Kubernetes secrets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#s3-credentials-secret" class="md-nav__link">
    <span class="md-ellipsis">
      
        S3 credentials secret
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agisoft-metashape-license-secret" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agisoft Metashape license secret
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-cpu-node-labeling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configure CPU node labeling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configure CPU node labeling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apply-cpu-node-labels" class="md-nav__link">
    <span class="md-ellipsis">
      
        Apply CPU node labels
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-cpu-node-labels" class="md-nav__link">
    <span class="md-ellipsis">
      
        Verify CPU node labels
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      
        How it works
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-mixed-mig-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enable mixed MIG strategy
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-mig-multi-instance-gpu" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configure MIG (Multi-Instance GPU)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configure MIG (Multi-Instance GPU)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mig-profiles" class="md-nav__link">
    <span class="md-ellipsis">
      
        MIG profiles
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply-mig-configuration-rule" class="md-nav__link">
    <span class="md-ellipsis">
      
        Apply MIG configuration rule
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-mig-is-working" class="md-nav__link">
    <span class="md-ellipsis">
      
        Verify MIG is working
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-it-works_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        How it works
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes management
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Kubernetes management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view-cluster-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        View cluster nodes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-shell-on-cluster-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Access shell on cluster nodes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-disk-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Check disk usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rotating-secrets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Rotating secrets
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-resizing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cluster resizing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cluster resizing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resize-the-default-worker-group" class="md-nav__link">
    <span class="md-ellipsis">
      
        Resize the default worker group
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-resize-or-delete-nodegroups" class="md-nav__link">
    <span class="md-ellipsis">
      
        Add, resize, or delete nodegroups
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-the-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      
        Delete the cluster
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-dashboards" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitoring dashboards
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring dashboards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#grafana-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grafana dashboard
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes dashboard
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes-from-testing-and-experimentation-attempting-to-set-up-autoscaling-and-fixed-nodegroups" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes from testing and experimentation attempting to set up autoscaling and fixed nodegroups
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Notes from testing and experimentation attempting to set up autoscaling and fixed nodegroups">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testingmonitoring-autoscaling-behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing/monitoring autoscaling behavior
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../manila-share-mounting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Manila share mounting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../argo-installation-on-cluster/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Argo installation on cluster
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#one-time-local-machine-software-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        One-time local machine software setup
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="One-time local machine software setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-python-and-create-virtual-environment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install Python and create virtual environment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-openstack-command-line-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install OpenStack command line tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-kubectl" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install kubectl
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-application-credential" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create application credential
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-openstack-keypair" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create OpenStack keypair
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-shell-completion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enable shell completion
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-creation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cluster creation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cluster creation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view-available-cluster-templates" class="md-nav__link">
    <span class="md-ellipsis">
      
        View available cluster templates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-the-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deploy the cluster
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up-kubectl-to-control-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Set up kubectl to control Kubernetes
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-argo-namespace" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the Argo namespace
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-kubernetes-secrets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create Kubernetes secrets
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create Kubernetes secrets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#s3-credentials-secret" class="md-nav__link">
    <span class="md-ellipsis">
      
        S3 credentials secret
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agisoft-metashape-license-secret" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agisoft Metashape license secret
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-cpu-node-labeling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configure CPU node labeling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configure CPU node labeling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apply-cpu-node-labels" class="md-nav__link">
    <span class="md-ellipsis">
      
        Apply CPU node labels
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-cpu-node-labels" class="md-nav__link">
    <span class="md-ellipsis">
      
        Verify CPU node labels
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      
        How it works
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-mixed-mig-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enable mixed MIG strategy
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-mig-multi-instance-gpu" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configure MIG (Multi-Instance GPU)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configure MIG (Multi-Instance GPU)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mig-profiles" class="md-nav__link">
    <span class="md-ellipsis">
      
        MIG profiles
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply-mig-configuration-rule" class="md-nav__link">
    <span class="md-ellipsis">
      
        Apply MIG configuration rule
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-mig-is-working" class="md-nav__link">
    <span class="md-ellipsis">
      
        Verify MIG is working
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-it-works_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        How it works
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes management
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Kubernetes management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#view-cluster-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        View cluster nodes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-shell-on-cluster-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Access shell on cluster nodes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-disk-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Check disk usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rotating-secrets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Rotating secrets
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-resizing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cluster resizing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cluster resizing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resize-the-default-worker-group" class="md-nav__link">
    <span class="md-ellipsis">
      
        Resize the default worker group
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-resize-or-delete-nodegroups" class="md-nav__link">
    <span class="md-ellipsis">
      
        Add, resize, or delete nodegroups
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-the-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      
        Delete the cluster
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-dashboards" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitoring dashboards
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring dashboards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#grafana-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grafana dashboard
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes dashboard
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes-from-testing-and-experimentation-attempting-to-set-up-autoscaling-and-fixed-nodegroups" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes from testing and experimentation attempting to set up autoscaling and fixed nodegroups
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Notes from testing and experimentation attempting to set up autoscaling and fixed nodegroups">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testingmonitoring-autoscaling-behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing/monitoring autoscaling behavior
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="cluster-creation-and-resizing">Cluster creation and resizing</h1>
<p>This guide is for the cluster administrator (currently Derek). Since we only need one cluster and
Derek is taking care of creating it, this guide is not necessary for the whole team. There is a
separate guide on cluster management that is for the whole team.</p>
<p><strong>Key resource</strong> referenced in creating this guide: <a href="https://gitlab.com/jetstream-cloud/jetstream2/eot/tutorials/magnum-tutorial/-/wikis/beginners_guide_to_magnum_on_JS2">Beginner's Guide to Magnum on
Jetstream2</a></p>
<h2 id="one-time-local-machine-software-setup">One-time local machine software setup</h2>
<p>These instructions will set up your local (Linux, Mac, or WSL) machine to control the cluster through the command line.</p>
<h3 id="install-python-and-create-virtual-environment">Install Python and create virtual environment</h3>
<p>Make sure you have a recent Python interpreter and the venv utility, then create a virtual environment for OpenStack management:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>update
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>python3-full<span class="w"> </span>python3-venv
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>~/venv/openstack
</code></pre></div>
<h3 id="install-openstack-command-line-tools">Install OpenStack command line tools</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Activate environment</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nb">source</span><span class="w"> </span>~/venv/openstack/bin/activate
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="c1"># Install OpenStack utilities</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>pip<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>python-openstackclient<span class="w"> </span>python-magnumclient<span class="w"> </span>python-designateclient
</code></pre></div>
<h3 id="install-kubectl">Install kubectl</h3>
<p>Install the Kubernetes control utility <code>kubectl</code> (from the <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/">official Kubernetes documentation</a>):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Install prerequisites</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>apt-transport-https<span class="w"> </span>ca-certificates<span class="w"> </span>curl<span class="w"> </span>gnupg
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1"># Add Kubernetes apt repository</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>gpg<span class="w"> </span>--dearmor<span class="w"> </span>-o<span class="w"> </span>/etc/apt/keyrings/kubernetes-apt-keyring.gpg
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">644</span><span class="w"> </span>/etc/apt/keyrings/kubernetes-apt-keyring.gpg
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/kubernetes.list
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">644</span><span class="w"> </span>/etc/apt/sources.list.d/kubernetes.list
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="c1"># Install kubectl</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>sudo<span class="w"> </span>apt<span class="w"> </span>update
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>kubectl
</code></pre></div>
<h3 id="create-application-credential">Create application credential</h3>
<p>In <a href="https://js2.jetstream-cloud.org">Horizon</a>, go to <strong>Identity &gt; Application Credentials</strong>. Click <strong>Create</strong>:</p>
<ul>
<li>Do not change the roles</li>
<li>Do not set a secret (one will be generated)</li>
<li><strong>Do</strong> set an expiration date</li>
<li><strong>Do</strong> check "unrestricted" (required because Magnum creates additional app credentials for the cluster)</li>
</ul>
<p>Download the openrc file and store it in the OFO <a href="http://vault.focal-lab.org">Vaultwarden</a> organization where OFO members can access it.</p>
<p>Copy the application credential onto your <strong>local computer</strong> (do not put it on a JS2 machine),
ideally into <code>~/.ofocluster/app-cred-ofocluster-openrc.sh</code> (which is where we will assume it is in
these docs).</p>
<p>Source the application credential (which sets relevant environment variables for the OpenStack command line tools):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nb">source</span><span class="w"> </span>~/.ofocluster/app-cred-ofocluster-openrc.sh
</code></pre></div>
<h3 id="create-openstack-keypair">Create OpenStack keypair</h3>
<p>Create a keypair for cluster node access. If you want, you can save the private key that is displayed when you run this command in order to SSH into the cluster nodes later. However, they won't have public IP addresses, so this is mainly to satisfy Magnum's requirements.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Create a new keypair (displays private key - save if needed)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>openstack<span class="w"> </span>keypair<span class="w"> </span>create<span class="w"> </span>my-openstack-keypair-name
</code></pre></div>
<p><strong>Alternatively</strong>, specify an existing public key you normally use, in this example <code>~/.ssh/id_rsa.pub</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># Use existing public key</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>openstack<span class="w"> </span>keypair<span class="w"> </span>create<span class="w"> </span>my-openstack-keypair-name<span class="w"> </span>--public-key<span class="w"> </span>~/.ssh/id_rsa.pub
</code></pre></div>
<h3 id="enable-shell-completion">Enable shell completion</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># Create directory for completion scripts</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>~/.bash_completion.d
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="c1"># Generate completion scripts</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>openstack<span class="w"> </span><span class="nb">complete</span><span class="w"> </span>&gt;<span class="w"> </span>~/.ofocluster/openstack-completion.bash
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>kubectl<span class="w"> </span>completion<span class="w"> </span>bash<span class="w"> </span>&gt;<span class="w"> </span>~/.ofocluster/kubectl-completion.bash
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="c1"># Add to ~/.bashrc</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;source ~/.ofocluster/openstack-completion.bash&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;source ~/.ofocluster/kubectl-completion.bash&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc
</code></pre></div>
<h2 id="cluster-creation">Cluster creation</h2>
<p>Assuming you're in a fresh shell session, enter your JS2 venv and source the application credential:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nb">source</span><span class="w"> </span>~/venv/openstack/bin/activate
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nb">source</span><span class="w"> </span>~/.ofocluster/app-cred-ofocluster-openrc.sh
</code></pre></div>
<h3 id="view-available-cluster-templates">View available cluster templates</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>openstack<span class="w"> </span>coe<span class="w"> </span>cluster<span class="w"> </span>template<span class="w"> </span>list
</code></pre></div>
<h3 id="deploy-the-cluster">Deploy the cluster</h3>
<p>Specify the deployment parameters and create the cluster. Choose the most recent Kubernetes version
(highest number in the template list). The master node can be <code>m3.small</code>. We'll deploy a cluster
with a single worker node that is also <code>m3.small</code>. When we need to scale up, we'll add nodegroups.
This initial spec is just the base setup for when we're not running Argo workloads on it. We need to
enable audo-scaling now, even though we don't want it for the default worker nodegroup, because
these settings apply to child nodegroups and it appears the max node count cannot be overridden.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Set deployment parameters</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="nv">TEMPLATE</span><span class="o">=</span><span class="s2">&quot;kubernetes-1-33-jammy&quot;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="nv">KEYPAIR</span><span class="o">=</span>my-openstack-keypair-name<span class="w"> </span><span class="c1"># what you created above</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="c1"># Network configuration</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="nv">NETWORK_ID</span><span class="o">=</span><span class="k">$(</span>openstack<span class="w"> </span>network<span class="w"> </span>show<span class="w"> </span>--format<span class="w"> </span>value<span class="w"> </span>-c<span class="w"> </span>id<span class="w"> </span>auto_allocated_network<span class="k">)</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="nv">SUBNET_ID</span><span class="o">=</span><span class="k">$(</span>openstack<span class="w"> </span>subnet<span class="w"> </span>show<span class="w"> </span>--format<span class="w"> </span>value<span class="w"> </span>-c<span class="w"> </span>id<span class="w"> </span>auto_allocated_subnet_v4<span class="k">)</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>openstack<span class="w"> </span>coe<span class="w"> </span>cluster<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">    </span>--cluster-template<span class="w"> </span><span class="nv">$TEMPLATE</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span>--master-count<span class="w"> </span><span class="m">1</span><span class="w"> </span>--node-count<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span>--master-flavor<span class="w"> </span>m3.small<span class="w"> </span>--flavor<span class="w"> </span>m3.small<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span>--merge-labels<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">    </span>--labels<span class="w"> </span><span class="nv">auto_scaling_enabled</span><span class="o">=</span>true,min_node_count<span class="o">=</span><span class="m">1</span>,boot_volume_size<span class="o">=</span><span class="m">80</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">    </span>--keypair<span class="w"> </span><span class="nv">$KEYPAIR</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">    </span>--fixed-network<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NETWORK_ID</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">    </span>--fixed-subnet<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SUBNET_ID</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">    </span><span class="s2">&quot;ofocluster2&quot;</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="c1">### Check cluster status (optional)</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="sb">```</span>bash
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>openstack<span class="w"> </span>coe<span class="w"> </span>cluster<span class="w"> </span>list
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>openstack<span class="w"> </span>coe<span class="w"> </span>cluster<span class="w"> </span>show<span class="w"> </span>ofocluster
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>openstack<span class="w"> </span>coe<span class="w"> </span>nodegroup<span class="w"> </span>list<span class="w"> </span>ofocluster
</code></pre></div>
<p>Or with formatting that makes it easier to copy the cluster UUID:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>openstack<span class="w"> </span>coe<span class="w"> </span>cluster<span class="w"> </span>list<span class="w"> </span>--format<span class="w"> </span>value<span class="w"> </span>-c<span class="w"> </span>uuid<span class="w"> </span>-c<span class="w"> </span>name
</code></pre></div>
<h2 id="set-up-kubectl-to-control-kubernetes">Set up <code>kubectl</code> to control Kubernetes</h2>
<p>This is required the first time you interact with Kubernetes on the cluster. <code>kubectl</code> is a tool to
control Kubernetes (the cluster's software, not its compute nodes/VMs) from your local command line.</p>
<p>Once the <code>openstack coe cluster list</code> status (command above) changes to <code>CREATE_COMPLETE</code>, get the Kubernetes configuration file (<code>kubeconfig</code>) and configure your environment:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># Get cluster configuration</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>openstack<span class="w"> </span>coe<span class="w"> </span>cluster<span class="w"> </span>config<span class="w"> </span><span class="s2">&quot;ofocluster2&quot;</span><span class="w"> </span>--force
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="c1"># Set permissions and move to appropriate location</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>chmod<span class="w"> </span><span class="m">600</span><span class="w"> </span>config
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>~/.ofocluster
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>mv<span class="w"> </span>-i<span class="w"> </span>config<span class="w"> </span>~/.ofocluster/ofocluster.kubeconfig
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="c1"># Set KUBECONFIG environment variable</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="nb">export</span><span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span>~/.ofocluster/ofocluster.kubeconfig
</code></pre></div>
<h2 id="create-the-argo-namespace">Create the Argo namespace</h2>
<p>We will install various resources into this namespace in this guide and subsequent ones.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>argo
</code></pre></div>
<h2 id="create-kubernetes-secrets">Create Kubernetes secrets</h2>
<p>The Argo workflows require two Kubernetes secrets to be created:</p>
<h3 id="s3-credentials-secret">S3 credentials secret</h3>
<p>The Argo workflows upload to and download from Jetstream2's S3-compatible buckets. You need to
create a secret to store the S3 Access ID, Secret Key, provider type, and endpoint URL. Obtain the access key ID and
secret access key from the OFO <a href="http://vault.focal-lab.org">Vaultwarden</a> organization. The
credentials were originally created by Derek following <a href="https://docs.jetstream-cloud.org/general/object/">JS2
docs</a> and particularly <code>openstack ec2 credentials
create</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>s3-credentials<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">  </span>--from-literal<span class="o">=</span><span class="nv">provider</span><span class="o">=</span><span class="s1">&#39;Other&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">  </span>--from-literal<span class="o">=</span><span class="nv">endpoint</span><span class="o">=</span><span class="s1">&#39;https://js2.jetstream-cloud.org:8001&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">  </span>--from-literal<span class="o">=</span><span class="nv">access_key</span><span class="o">=</span><span class="s1">&#39;&lt;YOUR_ACCESS_KEY_ID&gt;&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">  </span>--from-literal<span class="o">=</span><span class="nv">secret_key</span><span class="o">=</span><span class="s1">&#39;&lt;YOUR_SECRET_ACCESS_KEY&gt;&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">  </span>-n<span class="w"> </span>argo
</code></pre></div>
<h3 id="agisoft-metashape-license-secret">Agisoft Metashape license secret</h3>
<p>The photogrammetry workflow requires access to an Agisoft Metashape floating license server. Create
a secret to store the license server address. Obtain the license server IP address from the OFO
<a href="http://vault.focal-lab.org">Vaultwarden</a> organization.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>agisoft-license<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">  </span>--from-literal<span class="o">=</span><span class="nv">license_server</span><span class="o">=</span><span class="s1">&#39;&lt;LICENSE_SERVER_IP&gt;:5842&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">  </span>-n<span class="w"> </span>argo
</code></pre></div>
<p>Replace <code>&lt;LICENSE_SERVER_IP&gt;</code> with the actual IP address from the credentials document.</p>
<p>These secrets only need to be created once per cluster.</p>
<h2 id="configure-cpu-node-labeling">Configure CPU node labeling</h2>
<p>To prevent CPU workloads from being scheduled on expensive GPU nodes, CPU nodes are labeled based on their nodegroup naming pattern. CPU-only workflow templates use <code>nodeSelector</code> to explicitly target these labeled nodes, while GPU pods use resource requests that naturally constrain them to GPU nodes.</p>
<h3 id="apply-cpu-node-labels">Apply CPU node labels</h3>
<p>Label CPU nodes automatically based on their nodegroup naming pattern:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>setup/k8s/cpu-nodegroup-labels.yaml
</code></pre></div>
<p>This creates a NodeFeatureRule that automatically labels any node with <code>cpu</code> in its name with <code>feature.node.kubernetes.io/workload-type: cpu</code>. The label is applied by Node Feature Discovery (NFD) when the node joins the cluster.</p>
<div class="admonition important">
<p class="admonition-title">Nodegroup naming requirement</p>
<p>When creating CPU nodegroups, ensure the nodegroup name contains <code>cpu</code> (e.g., <code>cpu-group</code>, <code>cpu-m3xl</code>) so nodes are automatically labeled. See <a href="../../usage/cluster-access-and-resizing/#add-a-new-nodegroup">nodegroup creation</a> for details.</p>
</div>
<h3 id="verify-cpu-node-labels">Verify CPU node labels</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-L<span class="w"> </span>feature.node.kubernetes.io/workload-type
</code></pre></div>
<p>All nodes with <code>cpu</code> in their name should show <code>feature.node.kubernetes.io/workload-type=cpu</code>.</p>
<h3 id="how-it-works">How it works</h3>
<ul>
<li><strong>CPU pods</strong>: Use <code>nodeSelector: feature.node.kubernetes.io/workload-type: cpu</code> to explicitly target CPU nodes</li>
<li><strong>GPU pods</strong>: Request GPU resources (e.g., <code>nvidia.com/mig-1g.5gb</code>), which naturally constrains them to nodes advertising those resources</li>
<li><strong>System pods</strong>: DaemonSets run on all nodes as needed</li>
</ul>
<h3 id="enable-mixed-mig-strategy">Enable mixed MIG strategy</h3>
<p>The GPU Operator defaults to "single" MIG strategy, which exposes MIG slices as generic
<code>nvidia.com/gpu</code> resources. For MIG nodegroups to expose specific (and mixed) resources like
<code>nvidia.com/mig-2g.10gb</code> (optionally along with other MIG nodes or full nodes like <code>nvidia.com/gpu</code>), enable "mixed" strategy:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># Add NVIDIA helm repo (if not already added)</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>nvidia<span class="w"> </span>https://helm.ngc.nvidia.com/nvidia
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>helm<span class="w"> </span>repo<span class="w"> </span>update<span class="w"> </span>nvidia
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="c1"># Check current GPU Operator version</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>helm<span class="w"> </span>list<span class="w"> </span>-n<span class="w"> </span>gpu-operator
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="c1"># Enable mixed MIG strategy (use the same version as currently installed)</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>helm<span class="w"> </span>upgrade<span class="w"> </span>nvidia-gpu-operator<span class="w"> </span>nvidia/gpu-operator<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">  </span>-n<span class="w"> </span>gpu-operator<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">  </span>--version<span class="w"> </span>&lt;CURRENT_VERSION&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">  </span>--reuse-values<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">  </span>--set<span class="w"> </span>mig.strategy<span class="o">=</span>mixed
</code></pre></div>
<p>To check whether it took (or in the future to make sure it remained set), run the following and look for <code>strategy: mixed</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>helm<span class="w"> </span>get<span class="w"> </span>values<span class="w"> </span>nvidia-gpu-operator<span class="w"> </span>-n<span class="w"> </span>gpu-operator<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A1<span class="w"> </span><span class="s2">&quot;mig:&quot;</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Cluster upgrades</p>
<p>This setting may be reset if the cluster template is upgraded and Magnum redeploys the GPU Operator. Re-run this command after cluster upgrades if MIG resources stop appearing.</p>
</div>
<h2 id="configure-mig-multi-instance-gpu">Configure MIG (Multi-Instance GPU)</h2>
<p>MIG partitions A100 GPUs into isolated slices, allowing multiple pods to share one physical GPU with hardware-level isolation. This is optional - standard GPU nodegroups work without MIG.</p>
<h3 id="mig-profiles">MIG profiles</h3>
<table>
<thead>
<tr>
<th>Nodegroup pattern</th>
<th>MIG profile</th>
<th>Pods/GPU</th>
<th>VRAM each</th>
<th>GPU compute each</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mig1-*</code></td>
<td><code>all-1g.5gb</code></td>
<td>7</td>
<td>10GB</td>
<td>1/7</td>
</tr>
<tr>
<td><code>mig2-*</code></td>
<td><code>all-2g.10gb</code></td>
<td>3</td>
<td>10GB</td>
<td>2/7</td>
</tr>
<tr>
<td><code>mig3-*</code></td>
<td><code>all-3g.20gb</code></td>
<td>2</td>
<td>20GB</td>
<td>3/7</td>
</tr>
</tbody>
</table>
<h3 id="apply-mig-configuration-rule">Apply MIG configuration rule</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>setup/k8s/mig-nodegroup-labels.yaml
</code></pre></div>
<p>This creates a NodeFeatureRule that automatically labels GPU nodes based on their nodegroup name. The NVIDIA MIG manager watches for these labels and configures the GPU accordingly.</p>
<h3 id="verify-mig-is-working">Verify MIG is working</h3>
<p>After creating a MIG nodegroup (see <a href="../../usage/cluster-access-and-resizing/#mig-nodegroups">MIG nodegroups</a>):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># Check node MIG config label</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-l<span class="w"> </span>nvidia.com/mig.config<span class="w"> </span>-o<span class="w"> </span>custom-columns<span class="o">=</span><span class="s1">&#39;NAME:.metadata.name,MIG_CONFIG:.metadata.labels.nvidia\.com/mig\.config&#39;</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="c1"># Check MIG resources are available</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-o<span class="w"> </span>custom-columns<span class="o">=</span><span class="s1">&#39;NAME:.metadata.name,MIG-1G:.status.allocatable.nvidia\.com/mig-1g\.10gb,MIG-2G:.status.allocatable.nvidia\.com/mig-2g\.10gb,MIG-3G:.status.allocatable.nvidia\.com/mig-3g\.20gb&#39;</span>
</code></pre></div>
<h3 id="how-it-works_1">How it works</h3>
<ol>
<li>User creates nodegroup with MIG naming (e.g., <code>mig1-group</code>)</li>
<li>Node joins cluster with name containing <code>-mig1-</code></li>
<li>NFD applies label <code>nvidia.com/mig.config=all-1g.5gb</code></li>
<li>MIG manager detects label, configures GPU into 3 partitions</li>
<li>Device plugin exposes <code>nvidia.com/mig-1g.5gb: 3</code> as allocatable resources</li>
<li>Pods requesting <code>nvidia.com/mig-1g.5gb: 1</code> get one partition</li>
</ol>
<h2 id="kubernetes-management">Kubernetes management</h2>
<p>If you are resuming cluster management after a reboot, you will need to re-set environment variables and source the application credential:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nb">source</span><span class="w"> </span>~/venv/openstack/bin/activate
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span>~/.ofocluster/ofocluster.kubeconfig
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="nb">source</span><span class="w"> </span>~/.ofocluster/app-cred-ofocluster-openrc.sh
</code></pre></div>
<h3 id="view-cluster-nodes">View cluster nodes</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
</code></pre></div>
<h3 id="access-shell-on-cluster-nodes">Access shell on cluster nodes</h3>
<p>Run commands on a node with:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># Start a debug session on a specific node</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>kubectl<span class="w"> </span>debug<span class="w"> </span>node/&lt;node-name&gt;<span class="w"> </span>-it<span class="w"> </span>--image<span class="o">=</span>ubuntu
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="c1"># Once inside, you have host access via /host</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="c1"># Check kernel modules</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>chroot<span class="w"> </span>/host<span class="w"> </span>modprobe<span class="w"> </span>ceph
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>chroot<span class="w"> </span>/host<span class="w"> </span>lsmod<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ceph
</code></pre></div>
<h3 id="check-disk-usage">Check disk usage</h3>
<p>Run a one-off command to check disk usage:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>kubectl<span class="w"> </span>debug<span class="w"> </span>node/&lt;node-name&gt;<span class="w"> </span>-it<span class="w"> </span>--image<span class="o">=</span>busybox<span class="w"> </span>--<span class="w"> </span>df<span class="w"> </span>-h
</code></pre></div>
<p>Look for the <code>/dev/vda1</code> volume. Then delete the debugging pods:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>name<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>node-debugger<span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>kubectl<span class="w"> </span>delete
</code></pre></div>
<h3 id="rotating-secrets">Rotating secrets</h3>
<p>If you accidentally expose a secret, or for periodic rotation, delete, then re-create. Example for
S3 (assuming your S3 is via JS2 Swift):</p>
<p>List creds to get the ID of the cred you want to swap out: <code>openstack ec2 credentials list</code>
Delete it: <code>openstack ec2 credentials delete &lt;your-access-key-id&gt;</code>
Create a new one: <code>openstack ec2 credentials create</code>
Update it in <a href="http://vault.focal-lab.org">Vaultwarden</a>.
Delete the k8s secret: <code>kubectl delete secret -n argo s3-credentials</code>
Re-create k8s secret following the instructions above.
If you have already installed Argo on the cluster, restart the workflow controller so it picks up
the new creds: <code>kubectl rollout restart deployment workflow-controller -n argo</code></p>
<h2 id="cluster-resizing">Cluster resizing</h2>
<p>These instructions are for managing which nodes are in the cluster, not what software is running on them.</p>
<h3 id="resize-the-default-worker-group">Resize the default worker group</h3>
<p>Resize the cluster by adding or removing nodes from the original worker group (not a later-added nodegroup). We will likely not do this, relying instead on nodegroups for specific runs.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>openstack<span class="w"> </span>coe<span class="w"> </span>cluster<span class="w"> </span>resize<span class="w"> </span><span class="s2">&quot;ofocluster&quot;</span><span class="w"> </span><span class="m">4</span>
</code></pre></div>
<h3 id="add-resize-or-delete-nodegroups">Add, resize, or delete nodegroups</h3>
<p>For nodegroup management, see the corresponding <a href="../../usage/cluster-access-and-resizing/">user guide</a>.</p>
<h3 id="delete-the-cluster">Delete the cluster</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>openstack<span class="w"> </span>coe<span class="w"> </span>cluster<span class="w"> </span>delete<span class="w"> </span><span class="s2">&quot;ofocluster&quot;</span>
</code></pre></div>
<h2 id="monitoring-dashboards">Monitoring dashboards</h2>
<p>Incomplete notes in development.</p>
<h3 id="grafana-dashboard">Grafana dashboard</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1"># Port-forward Grafana to your local machine</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>kubectl<span class="w"> </span>port-forward<span class="w"> </span>-n<span class="w"> </span>monitoring-system<span class="w"> </span>svc/kube-prometheus-stack-grafana<span class="w"> </span><span class="m">3000</span>:80
</code></pre></div>
<p>Then open http://localhost:3000 in your browser.</p>
<h3 id="kubernetes-dashboard">Kubernetes dashboard</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1"># Create service account</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>kubectl<span class="w"> </span>create<span class="w"> </span>serviceaccount<span class="w"> </span>dashboard-admin<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="c1"># Create cluster role binding</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>kubectl<span class="w"> </span>create<span class="w"> </span>clusterrolebinding<span class="w"> </span>dashboard-admin<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">    </span>--clusterrole<span class="o">=</span>cluster-admin<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">    </span>--serviceaccount<span class="o">=</span>kubernetes-dashboard:dashboard-admin
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="c1"># Create token (24 hour duration)</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>kubectl<span class="w"> </span>create<span class="w"> </span>token<span class="w"> </span>dashboard-admin<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>--duration<span class="o">=</span>24h
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="c1"># Port-forward (if not already running)</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>kubectl<span class="w"> </span>port-forward<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>svc/kubernetes-dashboard<span class="w"> </span><span class="m">8443</span>:443
</code></pre></div>
<p>Then open https://localhost:8443 in your browser and use the token to log in.</p>
<h2 id="notes-from-testing-and-experimentation-attempting-to-set-up-autoscaling-and-fixed-nodegroups">Notes from testing and experimentation attempting to set up autoscaling and fixed nodegroups</h2>
<p>It seems impossible to set new (or override existing) labels when adding
nodegroups. Labels only seem to be intended/used for overall cluster creation. Also if
we deploy one nodegroup that violates the requirement for min_node_count to be specified, cannot
deploy any others (they all fail), even if they would have succeeded otherwise.</p>
<p>By not specifying a label <code>max_node_count</code> upon cluster creation, the default-worker nodegroup will
not autoscale. But still we need to set the label <code>auto_scaling_enabled</code> to <code>true</code> upon cluster
creation because cluster labels apparently cannot be overridden by nodegroups. This means that all
nodegroups will autoscale, and we are required to specify <code>--min-nodes</code>, or nodegroup clreation will
fail. If you don't specify <code>--max-nodes</code> when creating a nodegroup, it treats the <code>--node-count</code> as
the max and may scale down to the min.</p>
<p>I tried creating a cluster with no scaling (max nodes 1 and auto_scaling_enabled=false) and then
overriding it at the nodegroup level with values that should enable scaling, but it didn't scale
(apparently these values get overridden). Also tried not specifying
auto_scale_enabled label at all, but then specifying it for nodegroups, but these nodegroups did not
scale. Learned that <code>--node-count</code> needs to be within the range of the min and max (if omitted, it
is assumed to be 1).</p>
<h3 id="testingmonitoring-autoscaling-behavior">Testing/monitoring autoscaling behavior</h3>
<p>Deploy a bunch of pods that will need to get scheduled:
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>deployment<span class="w"> </span>scale-test<span class="w"> </span>--image<span class="o">=</span>nginx<span class="w"> </span>--replicas<span class="o">=</span><span class="m">20</span><span class="w"> </span>--<span class="w"> </span>sleep<span class="w"> </span>infinity<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>kubectl<span class="w"> </span><span class="nb">set</span><span class="w"> </span>resources<span class="w"> </span>deployment<span class="w"> </span>scale-test<span class="w"> </span>--requests<span class="o">=</span><span class="nv">cpu</span><span class="o">=</span>500m,memory<span class="o">=</span>512Mi
</code></pre></div></p>
<p>Make sure some become pending (which should trigger a scale up):
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pods
</code></pre></div></p>
<p>Monitor the cluster autoscaler status to see if it is planning any scaling up or down:
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>configmap<span class="w"> </span>cluster-autoscaler-status<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>-o<span class="w"> </span>yaml
</code></pre></div></p>
<p>When finished, delete the test deployment:
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>deployment<span class="w"> </span>scale-test
</code></pre></div></p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../" class="md-footer__link md-footer__link--prev" aria-label="Previous: Administrator guides">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Administrator guides
              </div>
            </div>
          </a>
        
        
          
          <a href="../manila-share-mounting/" class="md-footer__link md-footer__link--next" aria-label="Next: Manila share mounting">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Manila share mounting
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.footer", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>